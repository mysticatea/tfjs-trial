(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{147:function(t,e,n){},157:function(t,e,n){"use strict";var i=n(185);const o=1e-4,a=64,r=[4,4],s=4;class l{constructor(t,e){if(this.dimension=t,this.model=function({stateSize:t,actionSize:e}){const n=i.input({name:"INPUT",shape:t,dtype:"float32"}),l=function(t){let e=h(t,u(a,r),i.layers.batchNormalization({axis:1}),i.layers.activation({activation:"relu"}));for(let t=0;t<s;++t)e=c(e);return e}(n),d=function(t){const e=i.layers.dense({units:1,useBias:!1,activation:"tanh",kernelRegularizer:i.regularizers.l2({l2:o})});return h(t,u(1,[1,1]),i.layers.batchNormalization({axis:1}),i.layers.activation({activation:"relu"}),i.layers.flatten(),i.layers.dense({units:20,useBias:!1,activation:"linear",kernelRegularizer:i.regularizers.l2({l2:o})}),i.layers.activation({activation:"relu"}),e),e.output}(l),g=function(t,e){const n=i.layers.dense({units:e,useBias:!1,activation:"linear",kernelRegularizer:i.regularizers.l2({l2:o})});return h(t,u(2,[1,1]),i.layers.batchNormalization({axis:1}),i.layers.activation({activation:"relu"}),i.layers.flatten(),n),n.output}(l,e),p=i.model({inputs:[n],outputs:[d,g]});return p.compile({optimizer:"sgd",loss:["meanSquaredError","meanSquaredError"]}),p.lossFunctions[1]=i.losses.softmaxCrossEntropy,p}(t),e){const t=JSON.parse(e).weights.map(t=>i.tensor(t.values,t.shape,t.dtype));this.model.setWeights(t)}}get inputSize(){const[t,e,n]=this.dimension.stateSize;return t*e*n}async predict(t,e){const[n,o]=i.tidy(()=>{const n=i.tensor4d(t,[e,...this.dimension.stateSize],"float32");return this.model.predictOnBatch(n)}),a=await n.data(),r=await o.data();n.dispose(),o.dispose();const s=new Array(e),l=this.dimension.actionSize;for(let t=0;t<e;++t){const e=a[t],n=new Float32Array(r.buffer,r.byteOffset+4*t*l,l);s[t]={value:e,policy:n}}return s}async fit(t){const e=this.dimension;let n,o,a;try{return n=i.tensor4d(d(t,"state",e.stateSize[0]*e.stateSize[1]*e.stateSize[2]),[t.length,...e.stateSize],"float32"),o=i.tensor1d(function(t,e){const n=new Float32Array(t.length);for(let i=0;i<t.length;++i)n[i]=t[i][e];return n}(t,"value"),"float32"),a=i.tensor2d(d(t,"policy",e.actionSize),[t.length,e.actionSize],"float32"),await this.model.fit(n,[o,a])}finally{n&&n.dispose(),o&&o.dispose(),a&&a.dispose()}}serialize(){return i.tidy(()=>{const t=this.model.getWeights().map(t=>{return{values:Array.from(t.dataSync()),shape:t.shape,dtype:t.dtype}});return JSON.stringify({weights:t})})}}function c(t){let e=h(t,u(a,r),i.layers.batchNormalization({axis:1}),i.layers.activation({activation:"relu"}),u(a,r),i.layers.batchNormalization({axis:1}));return e=i.layers.add().apply([t,e]),e=i.layers.activation({activation:"relu"}).apply(e)}function u(t,e){return i.layers.conv2d({filters:t,kernelSize:e,dataFormat:"channelsFirst",padding:"same",useBias:!1,activation:"linear",kernelRegularizer:i.regularizers.l2({l2:o}),dtype:"float32"})}function h(t,...e){return e.reduce((t,e)=>e.apply(t),t)}function d(t,e,n){const i=new Float32Array(t.length*n);for(let o=0;o<t.length;++o){const a=t[o][e],r=o*n;for(let t=0;t<n;++t)i[r+t]=a[t]}return i}function g(t,e){const n=t.length;if(n<=e<<2)return function(t,e){const n=t.length,i=t.slice(0);for(let t=n<=e?n-1:e;t>0;--t){const e=Math.random()*n|0,o=i[t];i[t]=i[e],i[e]=o}n>e&&(i.length=e);return i}(t,e);const i=new Array(e),o=new Set;let a=0,r=0;for(;a<e;){do{r=Math.random()*n|0}while(o.has(r));o.add(r),i[a++]=t[r]}return i}const p=5;class f{constructor(t){this.nodes=new Map,this.rule=t,this.root=new f.Node(t.initialState),this.nodes.set(this.root.state.id,this.root)}changeRoot(t){const e=this.nodes.get(t.id);return e?this.root=e:(this.root=new f.Node(t),this.nodes.set(t.id,this.root)),this.root}getBestAction(){const t=new Float32Array(this.rule.actionSize),e=this.root.edges;let n=0,i=Number.MIN_SAFE_INTEGER;const o=[];for(const a of e)t[a.action]=a.n,n+=a.n,a.n>i&&(i=a.n,o.length=0),a.n===i&&o.push(a);for(let e=0;e<t.length;++e)t[e]/=n;const a=o.length,r=1===a?o[0]:o[Math.random()*a|0];return{state:r.outNode.state,action:r.action,value:r.q,policy:t}}getLeaves(t=1){return 0===this.root.edges.length?[{leaf:this.root,route:[]}]:g(this.root.edges,t).map(m).filter(y,new Set)}makeNextNodes(t,e,n){if(!0===t.done)throw new Error("duplicate makeNextNodes() call.");if(n.length!==t.state.actions.length)throw new Error("probs.length must be same as actions.length");t.value=e,t.done=!0;const i=t.state;for(let e=0,o=n.length;e<o;++e){const o=i.actions[e],a=n[e],r=this.rule.takeAction(i,o);let s=this.nodes.get(r.id);s||(s=new f.Node(r),this.nodes.set(r.id,s)),t.edges.push(new f.Edge(t,s,o,a))}}}function m(t){let e=t.outNode;const n=[t];for(;0!==e.edges.length;){const t=w(e);e=t.outNode,n.push(t)}return{leaf:e,route:n}}function y({leaf:t}){const e=t.state.id;return!this.has(e)&&(this.add(e),!0)}function w(t){const e=Math.sqrt(t.edges.reduce(v,0));let n,i=Number.NEGATIVE_INFINITY;for(const o of t.edges){const{n:t,q:a,prior:r}=o,s=a+p*r*e/(1+t);s>i&&(i=s,n=o)}return n}function v(t,e){return t+e.n}!function(t){t.Node=class{constructor(t){this.edges=[],this.value=0,this.done=!1,this.state=t}};t.Edge=class{constructor(t,e,n,i){this.n=0,this.w=0,this.q=0,this.inNode=t,this.outNode=e,this.action=n,this.prior=i}}}(f||(f={}));const b=8;class T{constructor({rule:t,serializedModel:e,maxThinkingTime:n={type:"count",value:10},onAct:i}){this.model=new l(t,e),this.mcts=new f(t),this.maxThinkingTime=n,this.onAct=i}reset(){this.mcts=new f(this.mcts.rule)}async act(t){if(this.mcts.changeRoot(t),"count"===this.maxThinkingTime.type)for(let t=this.maxThinkingTime.value;t>0;--t)await this.simulate();else{const t=Date.now()+this.maxThinkingTime.value;do{await this.simulate()}while(Date.now()<t)}const{state:e,action:n,value:i,policy:o}=this.mcts.getBestAction();if(this.onAct){const e=this.model.inputSize,a=new Float32Array(e);t.getStateData(a),this.onAct({state:a,action:n,value:i,policy:o})}return e}async simulate(){const t=this.mcts,e=t.getLeaves(b);if(0===e.length)return;const n=this.model.inputSize,i=new ArrayBuffer(4*n*e.length);for(let t=0;t<e.length;++t){const o=new Float32Array(i,4*t*n,n);e[t].leaf.state.getStateData(o)}const o=new Float32Array(i,0,n*e.length),a=await this.model.predict(o,e.length);for(let n=0;n<e.length;++n){const{leaf:i,route:o}=e[n],{value:r,policy:s}=a[n];if(!i.done){const e=i.state.actions,n=new Array(e.length);let o=0;for(let t=0;t<n.length;++t)o+=n[t]=Math.exp(s[e[t]]);for(let t=0;t<n.length;++t)n[t]/=o;t.makeNextNodes(i,r,n)}x(i,o)}}}function x(t,e){const n=t.state.playerTurn,i=t.value;for(const t of e){const e=t.inNode.state.playerTurn===n?1:-1;t.n=t.n+1,t.w=t.w+i*e,t.q=t.w/t.n}}class S{constructor(t){this.onAct=t}act(t){return new Promise((e,n)=>{this.onAct(t,e,n)})}}class z{constructor(t){this.rule=t}async play({players:t,signal:e,onThinkStart:n,onThinkEnd:i,onUpdate:o}){let a=this.rule.initialState,r=t[a.playerTurn];o&&(await o(a),N(e));do{n&&(await n(a,r),N(e)),a=await r.act(a),N(e),i&&(await i(a,r),N(e)),o&&(await o(a),N(e)),r=t[a.playerTurn]}while(a.actions.length>0);return a}}function N(t){if(t&&t.aborted)throw new Error("aborted")}class E{constructor(t){this.rule=t}async train({numPlayers:t=2,playingLoops:e=30,trainingLoops:n=30,trainingSample:i=256,scoreThreshold:o=.75,maxThinkingTime:a,initialSerializedModel:r,signal:s,onEpisodeBegin:l,onEpisodeEnd:c,onPlayBegin:u,onPlayEnd:h,onPlayStateChange:d,onTrainBegin:p,onTrainEnd:f}={}){const m=this.rule,y=new z(m),w=[],v=Array.from({length:t-1},()=>new T({rule:m,serializedModel:r,maxThinkingTime:a})),b=new T({rule:m,serializedModel:r,maxThinkingTime:a,onAct(t){w.push(t)}});for(let a=0;;++a){l&&(await l(a),k(s));let r=0;for(let n=0;n<e;++n){u&&(await u(a,n),k(s));const e=n%t,i=v.slice(0);i.splice(e,0,b);const o=await y.play({players:i,signal:s,onUpdate:d&&(t=>d(a,n,t))});k(s);const[l,c,g]=this.rule.stateSize,p=new Float32Array(l*c*g);o.getStateData(p),w.push({state:p,value:o.winner===e?1:-1,policy:new Float32Array(this.rule.actionSize)}),o.winner===e&&(r+=1),h&&(await h(a,n,r/(n+1)),k(s));for(const t of v)t.reset();b.reset()}if(a>=1&&r/e>=o)return{finalSerializedModel:b.model.serialize()};const c=b.model;for(let t=0;t<n;++t){const e=g(w,i);p&&(await p(a,t),k(s));const{epoch:n,history:o}=await c.fit(e);k(s),f&&(await f(a,t,n,o),k(s))}w.length=0}}}function k(t){if(t&&t.aborted)throw new Error("aborted")}n.d(e,"a",function(){return T}),n.d(e,!1,function(){return l}),n.d(e,"b",function(){return S}),n.d(e,"c",function(){return z}),n.d(e,"d",function(){return E})},158:function(t,e,n){"use strict";n.d(e,"a",function(){return o});var i=n(1);function o(){return new Promise(t=>i.a.nextTick(()=>setTimeout(t,0)))}},170:function(t,e,n){"use strict";var i=n(147);n.n(i).a},183:function(t,e){},196:function(t,e,n){"use strict";n.r(e);n(188),n(187);var i=n(1),o=n(186),a=n(157),r=n(158);function s(t){return function(){var e=this,n=arguments;return new Promise(function(i,o){var a=t.apply(e,n);function r(t,e){try{var n=a[t](e),r=n.value}catch(t){return void o(t)}n.done?i(r):Promise.resolve(r).then(s,l)}function s(t){r("next",t)}function l(t){r("throw",t)}s()})}}var l,c,u={name:"TrainingPane",props:{rule:{type:Object,required:!0}},data:function(){return{messages:[],isExecuting:!1,playingLoops:30,trainingLoops:30,depth:10,abortController:null}},beforeDestroy:function(){this.abort()},methods:{train:(c=s(regeneratorRuntime.mark(function t(){var e,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.isExecuting=!0,this.abortController=new o.AbortController,t.prev=2,this.log("info","強化学習を開始しました。"),e=new a.d(this.rule),t.next=7,e.train({playingLoops:Number(this.playingLoops)||30,trainingLoops:Number(this.trainingLoops)||30,maxThinkingTime:{type:"count",value:Number(this.depth)||10},signal:this.abortController.signal,onEpisodeBegin:this.onEpisodeBegin,onPlayBegin:this.onPlayBegin,onPlayEnd:this.onPlayEnd,onPlayStateChange:this.onPlayStateChange,onTrainBegin:this.onTrainBegin,onTrainEnd:this.onTrainEnd});case 7:n=t.sent,this.log("trace",n.finalSerializedModel),this.log("info","強化学習を完了しました。"),t.next=15;break;case 12:t.prev=12,t.t0=t.catch(2),"aborted"===t.t0.message?this.log("info","中止しました。"):this.log("error",t.t0.stack);case 15:return t.prev=15,this.isExecuting=!1,this.abortController=null,t.finish(15);case 19:case"end":return t.stop()}},t,this,[[2,12,15,19]])})),function(){return c.apply(this,arguments)}),abort:function(){this.abortController&&this.abortController.abort()},onEpisodeBegin:function(t){return this.log("trace","エピソード ".concat(t," を開始しました。"))},onPlayBegin:function(t,e){return this.log("trace","自己対戦 ".concat(e,"/").concat(this.playingLoops," を実行しています。"))},onPlayEnd:function(t,e,n){return this.log("trace","現在のスコア ".concat(n.toFixed(3),"。"))},onPlayStateChange:function(t,e){return this.tick()},onTrainBegin:function(t,e){return this.log("trace","ネットワーク更新 ".concat(e,"/").concat(this.trainingLoops," を実行しています。"))},onTrainEnd:function(t,e,n,i){return this.log("trace","評価データ: ".concat(JSON.stringify({epoch:n,history:i})))},log:(l=s(regeneratorRuntime.mark(function t(e,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return console["trace"===e?"log":e](n),this.messages.push({type:e,message:n}),t.next=4,i.a.nextTick();case 4:return(o=this.$refs.container).scrollTop=Math.max(0,o.scrollHeight-o.clientHeight),t.next=8,new Promise(function(t){return setTimeout(t,0)});case 8:case"end":return t.stop()}},t,this)})),function(t,e){return l.apply(this,arguments)}),tick:function(){var t=this.messages[this.messages.length-1];return t&&"trace"===t.type&&/^\.+$/.test(t.message)?(console.log("."),t.message+=".",Object(r.a)()):this.log("trace",".")}}},h=(n(170),n(0)),d=Object(h.a)(u,function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"training-pane-root"},[n("div",{staticClass:"training-pane-settings"},[t.isExecuting?n("button",{on:{click:t.abort}},[t._v("❌ 中止する")]):n("button",{on:{click:t.train}},[t._v("▶️ 開始する")]),t._v("\n        (\n        "),n("label",[t._v("読みの深さ "),n("input",{directives:[{name:"model",rawName:"v-model",value:t.depth,expression:"depth"}],attrs:{disabled:t.isExecuting,type:"number"},domProps:{value:t.depth},on:{input:function(e){e.target.composing||(t.depth=e.target.value)}}})]),n("label",[t._v("自己対戦回数 "),n("input",{directives:[{name:"model",rawName:"v-model",value:t.playingLoops,expression:"playingLoops"}],attrs:{disabled:t.isExecuting,type:"number"},domProps:{value:t.playingLoops},on:{input:function(e){e.target.composing||(t.playingLoops=e.target.value)}}})]),n("label",[t._v("更新処理回数 "),n("input",{directives:[{name:"model",rawName:"v-model",value:t.trainingLoops,expression:"trainingLoops"}],attrs:{disabled:t.isExecuting,type:"number"},domProps:{value:t.trainingLoops},on:{input:function(e){e.target.composing||(t.trainingLoops=e.target.value)}}})]),t._v("\n        )\n    ")]),n("ol",{ref:"container",staticClass:"training-pane-log-container"},t._l(t.messages,function(e,i){var o=e.type,a=e.message;return n("li",{key:i,class:"training-pane-log-"+o},[t._v("\n            "+t._s(a)+"\n        ")])}))])},[],!1,null,null,null);e.default=d.exports}}]);